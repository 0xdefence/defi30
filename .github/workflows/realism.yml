name: realism-eval

on:
  workflow_dispatch:
  push:
    paths:
      - "contracts/**"
      - "src/**"
      - "scripts/run-realism.sh"
      - "results/0xdefend-v1.json"

jobs:
  realism:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Setup Foundry
        uses: foundry-rs/foundry-toolchain@v1

      - name: Install deps
        run: bun install

      - name: Run realism harness
        run: ./scripts/run-realism.sh ./results/0xdefend-v1.json

      - name: Enforce required realism validations are executed
        run: |
          python3 - <<'PY'
          import json
          from pathlib import Path

          root = Path('.')
          submission = json.loads((root / 'results' / 'submission-with-realism.json').read_text())
          sub_map = {c.get('contractId'): c for c in submission.get('contracts', [])}

          missing = []
          for tier in ['tier1', 'tier2', 'tier3']:
            tdir = root / 'contracts' / tier
            if not tdir.exists():
              continue
            for case in tdir.iterdir():
              gt_path = case / 'ground-truth.json'
              if not case.is_dir() or not gt_path.exists():
                continue
              gt = json.loads(gt_path.read_text())
              cid = case.name
              sub = sub_map.get(cid, {})

              if gt.get('exploitValidationRequired'):
                status = (sub.get('exploitValidation') or {}).get('status')
                if status == 'not-run' or status is None:
                  missing.append(f'{cid}: exploitValidation not executed')

              if gt.get('patchValidationRequired'):
                status = (sub.get('patchValidation') or {}).get('status')
                if status == 'not-run' or status is None:
                  missing.append(f'{cid}: patchValidation not executed')

          if missing:
            print('Required realism validations were not executed:')
            for m in missing:
              print('-', m)
            raise SystemExit(1)

          print('All required realism validations executed.')
          PY

      - name: Score realism submission
        run: bun run src/cli.ts score ./results/submission-with-realism.json --strict

      - name: Upload realism artifacts
        uses: actions/upload-artifact@v4
        with:
          name: realism-artifacts
          path: |
            results/realism-validation.json
            results/submission-with-realism.json
            results/latest-report.json
            results/latest-report.md
